# Unified Multi-Agent Guided Learning Architecture

## 1. System Overview: The Orchestration Workflow

The system operates as a central state machine managing a loop of **Assessment $\to$ Strategy $\to$ Execution $\to$ Review**. It is not merely a linear chain of agents but a dynamic loop that adapts to the user's state.

**Core Workflow:**
- Path Generator creates diverse tutoring paths.
- User selects a path.
- Tutor generates first node output (without evaluation feedback)
- User responds to first node output
- Evaluator assesses user response (Remediate or Advance)
- Tutor Agent produces either Remediation with Evaluator feedback or Next Node
- Pedagogical Reviewer Agent reviews and enhances Tutor output
- and so on...
- Until last node is complete. Finish

### State Transition Logic (The "Engine" Rules)
- **Advance Condition**: `current_index` increments **ONLY** when `Evaluator.should_advance` is `true`.
- **Remediation Loop**: If `should_advance` is `false`, the system stays on the `current_node`. The Tutor uses `guidance_for_tutor` to re-explain or simplify the concept. This naturally handles "stuck" users without complex sub-path branching.

---

## 2. Data Structure: The Session State

A robust State Object is passed between agents to maintain context and prevent hallucinations.

```json
{
  "session_id": "uuid",
  "lesson_context": {
    "title": "Lesson Title",
    "objectives": "Learning objectives..."
  },
  "teaching_path": [ ... ],      // Generated by Path Generator and chosen by user. 
  "current_index": 0,            // Pointer to current node in teaching_path
  "history": [                   // Rolling window of last 6-10 turns
    {"role": "tutor", "content": "..."},
    {"role": "user", "content": "..."}
  ],
  "last_feedback_loop": {        // Temporary state for Reviewer loops
    "retry_count": 0,
    "reviewer_notes": null
  }
}
```

---

## 3. Agent Specifications

### 1. **Path Generator Agent** üó∫Ô∏è (The Architect)

**Responsibility**: Analyze lesson objectives and creates structured, atomic learning paths.

**Input**:
- Lesson title
- Learning objectives

**Output** (runs ONCE per session):
- Breaks objectives into **Atomic Concepts** to prevent cognitive overload.
- Includes **Introductory Node** (overview) and **Closing Node** (summary).
- Returns a list of path objects (diverse approaches). 

```json
{
  "paths": [
    {
      "id": "1",
      "name": "Standard Approach",
      "description": "Step-by-step breakdown",
      "teaching_sequence": [
        {
          "id": "node_1",
          "concept": "Introduction to Topic",
          "goal": "Provide high-level overview and context"
        },
        {
          "id": "node_2",
          "concept": "Core Concept A",
          "goal": "Ensure understanding of A before moving to B"
        },
        {
          "id": "node_3",
          "concept": "Summary",
          "goal": "Recap and verify total retention"
        }
      ]
    },
    ...
  ]
}
```

**Characteristics**:
- **Field-agnostic**: Works for any domain.
- **Atomic**: Avoids "walls of text".
- **Creates diverse tutoring approaches**: Addressing same topics and concepts but through different angles

---

### 2. **Evaluator Agent** ‚úÖ (The Diagnostician)

**Responsibility**: Assess user input to determine intent and understanding.

**Input**:
- User's message
- Current teaching node (concept & goal)
- Conversation history (Last 2 turns)
- Tutor's previous contents and question (for context)

**Output**:
- **Intent Classification**: Is the user answering, asking a question, or stuck?
- **Assessment**: If answering, is it correct?
- **Guidance**: Strategic direction for the Tutor on how to build next explanation.
- **Should Advance**: Whether the user is ready to advance to the next node. Proof of good understanding and active recall.

```json
{
  "user_intent": "attempt_answer" | "ask_question" | "stuck",
  "evaluation": "correct" | "partial" | "wrong" | "n/a",
  "reasoning": "User correctly identified X but missed Y...",
  "guidance_for_tutor": "Acknowledge and praise the correct part, but ask a follow-up about Y to clarify misconception.",
  "should_advance": true | false
}
```

**Characteristics**:
- **Temperature**: 0.1 (Deterministic).
- **Generous criteria**: "Did they grasp the core idea?"
- **Specific Feedback**: Pinpoints exact gaps.
- **Guidance**: Tell tutor HOW to respond (deepen on certain area, re-teach with different analogy, etc.) or to proceed to next teaching point.


---

### 3. **Tutor Agent** üë®‚Äçüè´ (The Guide)

**Responsibility**: Deliver focused teaching segments and generate responses based on Evaluator guidance.

**Input**:
- `strategy_directive` (from Evaluator) (First iteration does not exist)
- `current_node` (content to teach)
- `pedagogical_feedback` (if retrying from Reviewer)
- User and Tutor conversation history: Making the whole teaching process smooth and adaptive (bridging previous concepts, adjusting difficulty, etc.)

**Process**:
- Uses **Chain-of-Thought (CoT)**: Drafts the "Active Recall Question" internally before generating final JSON.

**Output**:
```json
{
  "teaching": "Clear explanation and bridge from previous concept if possible...",
  "question": "Engaging question leveraging active recall or application..."
}
```

**Characteristics**:
- **Temperature**: 0.5 (Creative).
- **Stateless regarding plan**: Renders the current step/strategy provided.
- **Question**: Dynamic and engaging - can be scenario-based, prediction, contrast, cause-effect, etc.
- **Question**: Should be an appropriately challenging question or a zone of proximal development. 
- Follow pedagogical reviewer feedback if provided

---

### 4. **Pedagogical Reviewer Agent** üéì (The Quality Control)

**Responsibility**: Ensure teaching quality and adherence to learning principles.

**Input**:
- Tutor's proposed output
- Current teaching point
- **7 Learning Principles Checklist**:
    1.  Active Learning (Generation Effect)
    2.  Cognitive Load Management (One concept per turn)
    3.  Adaptive Scaffolding & Fading (ZPD) Keep the user in the zone of proximal development. 
    4.  Misconception Diagnosis - Treat errors as signals, not failures.
    5.  Curiosity & Relevance - Connect abstract concepts to concrete problems or "hooks."
    6.  Emotional Awareness - Acknowledge user's emotions and provide support.
    7.  Interleaving & Transfer - Introduce related concepts to build transferable skills.

**Output**:
```json
{
  "approved": true | false,
  "feedback": "Question is too abstract. Use scenario: 'If etcd crashes...'"
}
```

**Characteristics**:
- **Gatekeeper**: Blocks bad outputs.
- **Feedback Loop**: Triggers Tutor retry if not approved (tracked in `last_feedback_loop`).
- **Safety Fallback**: **Max Retries = 3**. If limit is reached, the system **bypasses** the Reviewer and sends the **last generated Tutor response** to the user to prevent infinite loops.

---

## 4. Technical Optimization Strategy

### Context Management
- **Path Generator**: Only needs lesson objectives.
- **Evaluator**: Needs tight context (last 2 turns) to judge immediate response.
- **Tutor**: Needs broader context (last 4-6 turns) for conversational flow.
- **Reviewer**: Needs only the immediate Tutor proposal and context of the current node.

### Configuration
- **Standard Model**: `llama-4-maverick-17b` (or equivalent high-performance model).
